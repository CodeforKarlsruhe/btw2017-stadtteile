<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Die Bundestagswahl 2017 in den Karlsruher Stadtteilen</title>
        <script src="vendor/d3.v4.min.js"></script>
        <script src="vendor/simple-statistics.v5.0.0.min.js"></script>

        <style>
            .point, .dimmed {
                opacity: 0.2;
            }

            .highlighted {
                opacity: 1.0;
            }
        </style>
    </head>
    <body>
        <button id="button-next">Next</button>
        <span id="statistic-title"></span>
        <script>
            var MARGIN = {top: 20, right: 50, bottom: 20, left: 50};
            var OUTER_WIDTH = 960;
            var OUTER_HEIGHT = 500;

            var width = OUTER_WIDTH - MARGIN.left - MARGIN.right
                height = OUTER_HEIGHT - MARGIN.top - MARGIN.bottom;

            var svg = d3.select("body").append("svg")
                .attr("width", OUTER_WIDTH)
                .attr("height", OUTER_HEIGHT)
                .append("g")
                    .attr("transform", "translate(" + MARGIN.left + "," + MARGIN.top + ")");

            var xScale = d3.scaleLinear()
                .domain([0, 100])
                .range([0, width]);
            var yScale = d3.scaleLinear()
                .domain([0, 40])
                .range([height, 0]);

            var xAxis = d3.axisBottom(xScale)
                .ticks(5);
            var yAxis = d3.axisLeft(yScale)
                .ticks(5);

            var currentStatistic = 0;

            // Transition settings
            var t = d3.transition()
                .duration(750);

            var partyColors = {
                "CDU": "#000",
                "SPD": "#e3000f",
                "AfD": "#009ee0",
                "Gr√ºne": "#1aa037",
                "FDP": "#ffed00",
                "Linke": "#be3075",
            };

            function getTickValues(min, max) {
                var tickValues = [min, max];
                var exp = Math.max(Math.floor(Math.log10(Math.abs(min))), Math.ceil(Math.log10(Math.abs(max))));
                var step = Math.pow(10, exp);
                var j = 0;
                while (tickValues.length < 5 && step >= 1) {
                    for (var i = Math.ceil(min / step) * step; i < max; i += step) {
                        tickValues.push(i);
                    }
                    if (j === 0) {
                      step /= 2;
                    } else {
                      step /= 5;
                    }
                    j = 1 - j;
                    tickValues = unique(tickValues);
              }
              return tickValues;

            }

            var voteSymbols = {
                "Erststimme": d3.symbol().type(d3.symbolCircle),
                "Zweitstimme": d3.symbol().type(d3.symbolTriangle),
            }

            function mouseIn(party) {
                d3.selectAll(".line")
                    .interrupt()
                    .transition(t)
                    .style("opacity", 0.2);
                d3.selectAll("." + party)
                    .interrupt()
                    .transition(t)
                    .style("opacity", 1);
            }

            function mouseOut() {
                d3.selectAll(".line")
                    .interrupt()
                    .transition(t)
                    .style("opacity", 1);
                d3.selectAll(".point")
                    .interrupt()
                    .transition(t)
                    .style("opacity", 0.2);
            }

            d3.json("statistics.json", function (error, statistics) {
                if (error) {
                    throw error;
                }

                d3.json("votes.json", function (error, votes) {
                    if (error) {
                        throw error;
                    }

                    var partyVotes = {}
                    for (var party in partyColors) {
                        partyVotes[party] = [];
                    }
                    for (var i = 0; i < votes.length; i++) {
                        partyVotes[votes[i].party].push(votes[i]);
                    }

                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);
                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis);

                    svg.selectAll(".point")
                        .data(votes)
                        .enter().append("path")
                            .attr("class", function (d) { return "point " + d.party; })
                            .attr("d", function (d) { return voteSymbols[d.type](); })
                            .attr('fill', function (d) { return partyColors[d.party]; })

                    var partyLines = {};
                    for (var party in partyColors) {
                        (function (party) {
                            partyLines[party] = svg.append("line")
                                .attr("class", "line " + party)
                                .attr("stroke", partyColors[party])
                                .attr("stroke-width", 7)
                                .attr("fill", "none")
                                .on("mouseover", function () { mouseIn(party); })
                                .on("mouseout", mouseOut);
                        })(party);
                    }

                    function showStatistic(index) {
                        index = index % statistics.length;
                        currentStatistic = index;
                        var statistic = statistics[index];
                        var min = d3.min(d3.values(statistic.values));
                        var max = d3.max(d3.values(statistic.values));

                        xScale.domain(statistic.domain);
                        xAxis.tickValues(getTickValues(statistic.domain[0], statistic.domain[1]));
                        svg.selectAll(".x.axis")
                            .transition(t)
                            .call(xAxis);

                        svg.selectAll(".point")
                            .data(votes)
                            .on("mouseover", function (d) { mouseIn(d.party); })
                            .on("mouseout", mouseOut)
                            .transition(t)
                            .attr("transform", function (d) {
                                var x = xScale(statistic.values[d.district]);
                                var y = yScale(d.percentage);
                                return "translate(" + x + "," + y + ")";
                            });

                        for (var party in partyVotes) {
                            var points = [];
                            var pvs = partyVotes[party];
                            for (var i = 0; i < pvs.length; i++) {
                                var pv = pvs[i];
                                points.push([statistic.values[pv.district], pv.percentage]);
                            }
                            var line = ss.linearRegressionLine(ss.linearRegression(points));
                            partyLines[party].transition(t)
                                .attr("x1", xScale(min))
                                .attr("y1", yScale(line(min)))
                                .attr("x2", xScale(max))
                                .attr("y2", yScale(line(max)));
                        }

                        d3.select('#statistic-title').html(statistic.title);
                    }

                    d3.select('#button-next').on("click", function () {
                        showStatistic(currentStatistic + 1);
                    });

                    showStatistic(currentStatistic);
                });
            });


            // From https://stackoverflow.com/a/11911532/857390
            function unique(arr) {
                var u = {}, a = [];
                for(var i = 0, l = arr.length; i < l; ++i){
                    if(!u.hasOwnProperty(arr[i])) {
                        a.push(arr[i]);
                        u[arr[i]] = 1;
                    }
                }
                return a;
            }



        </script>
    </body>
</html>

